// <copyright file="HttpClientConfiguration.cs" company="APIMatic">
// PaypalServerSdk.Standard
//
// This file was automatically generated by APIMATIC v3.0 ( https://www.apimatic.io ).
// </copyright>
using APIMatic.Core.Http.Configuration;
using PaypalServerSdk.Standard.Http.Client.Proxy;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Net.Http;

namespace PaypalServerSdk.Standard.Http.Client
{
    /// <summary>
    /// HttpClientConfiguration represents the current state of the Http Client.
    /// </summary>
    public class HttpClientConfiguration : IHttpClientConfiguration
    {
        private readonly CoreHttpClientConfiguration coreHttpClientConfiguration;

        private HttpClientConfiguration(
            CoreHttpClientConfiguration.Builder coreHttpClientConfigurationBuilder)
        {
            coreHttpClientConfiguration = coreHttpClientConfigurationBuilder.Build();
        }

        /// <summary>
        /// Gets Http client timeout.
        /// </summary>
        public TimeSpan Timeout { get => coreHttpClientConfiguration.Timeout; }

        /// <summary>
        /// Gets Number of times the request is retried.
        /// </summary>
        public int NumberOfRetries { get => coreHttpClientConfiguration.NumberOfRetries; }

        /// <summary>
        /// Gets Exponential backoff factor for duration between retry calls.
        /// </summary>
        public int BackoffFactor { get => coreHttpClientConfiguration.BackoffFactor; }

        /// <summary>
        /// Gets The time interval between the endpoint calls.
        /// </summary>
        public double RetryInterval { get => coreHttpClientConfiguration.RetryInterval; }

        /// <summary>
        /// Gets The maximum retry wait time.
        /// </summary>
        public TimeSpan MaximumRetryWaitTime { get => coreHttpClientConfiguration.MaximumRetryWaitTime; }

        /// <summary>
        /// Gets List of Http status codes to invoke retry.
        /// </summary>
        public IList<int> StatusCodesToRetry { get => coreHttpClientConfiguration.StatusCodesToRetry; }

        /// <summary>
        /// Gets List of Http request methods to invoke retry.
        /// </summary>
        public IList<HttpMethod> RequestMethodsToRetry { get => coreHttpClientConfiguration.RequestMethodsToRetry; }

        /// <summary>
        /// Gets HttpClient instance used to make the HTTP calls
        /// </summary>
        public HttpClient HttpClientInstance { get => coreHttpClientConfiguration.HttpClientInstance; }

        /// <summary>
        /// Gets Boolean which allows the SDK to override http client instance's settings used for features like retries, timeouts etc.
        /// </summary>
        public bool OverrideHttpClientConfiguration { get => coreHttpClientConfiguration.OverrideHttpClientConfiguration; }

        /// <inheritdoc/>
        public override string ToString()
        {
            return "HttpClientConfiguration: " +
                $"{Timeout} , " +
                $"{NumberOfRetries} , " +
                $"{BackoffFactor} , " +
                $"{RetryInterval} , " +
                $"{MaximumRetryWaitTime} , " +
                $"{StatusCodesToRetry} , " +
                $"{RequestMethodsToRetry} , " +
                $"{HttpClientInstance} , " +
                $"{OverrideHttpClientConfiguration} ";
        }

        /// <summary>
        /// Creates an object of the HttpClientConfiguration using the values provided for the builder.
        /// </summary>
        /// <returns>Builder.</returns>
        public Builder ToBuilder()
          => new Builder()
          {
              CoreHttpClientConfigurationBuilder = coreHttpClientConfiguration.ToBuilder()
          };

        /// <summary>
        /// Builder class.
        /// </summary>
        public class Builder
        {
            internal CoreHttpClientConfiguration.Builder CoreHttpClientConfigurationBuilder { private get; set; } = new CoreHttpClientConfiguration.Builder();

            /// <summary>
            /// Sets the Timeout.
            /// </summary>
            /// <param name="timeout"> Timeout. </param>
            /// <returns>Builder.</returns>
            public Builder Timeout(TimeSpan timeout)
            {
                CoreHttpClientConfigurationBuilder = CoreHttpClientConfigurationBuilder.Timeout(timeout);
                return this;
            }

            /// <summary>
            /// Sets the NumberOfRetries.
            /// </summary>
            /// <param name="numberOfRetries"> NumberOfRetries. </param>
            /// <returns>Builder.</returns>
            public Builder NumberOfRetries(int numberOfRetries)
            {
                CoreHttpClientConfigurationBuilder = CoreHttpClientConfigurationBuilder.NumberOfRetries(numberOfRetries);
                return this;
            }

            /// <summary>
            /// Sets the BackoffFactor.
            /// </summary>
            /// <param name="backoffFactor"> BackoffFactor. </param>
            /// <returns>Builder.</returns>
            public Builder BackoffFactor(int backoffFactor)
            {
                CoreHttpClientConfigurationBuilder = CoreHttpClientConfigurationBuilder.BackoffFactor(backoffFactor);
                return this;
            }

            /// <summary>
            /// Sets the RetryInterval.
            /// </summary>
            /// <param name="retryInterval"> RetryInterval. </param>
            /// <returns>Builder.</returns>
            public Builder RetryInterval(double retryInterval)
            {
                CoreHttpClientConfigurationBuilder = CoreHttpClientConfigurationBuilder.RetryInterval(retryInterval);
                return this;
            }

            /// <summary>
            /// Sets the MaximumRetryWaitTime.
            /// </summary>
            /// <param name="maximumRetryWaitTime"> MaximumRetryWaitTime. </param>
            /// <returns>Builder.</returns>
            public Builder MaximumRetryWaitTime(TimeSpan maximumRetryWaitTime)
            {
                CoreHttpClientConfigurationBuilder = CoreHttpClientConfigurationBuilder.MaximumRetryWaitTime(maximumRetryWaitTime);
                return this;
            }

            /// <summary>
            /// Sets the StatusCodesToRetry.
            /// </summary>
            /// <param name="statusCodesToRetry"> StatusCodesToRetry. </param>
            /// <returns>Builder.</returns>
            public Builder StatusCodesToRetry(IList<int> statusCodesToRetry)
            {
                CoreHttpClientConfigurationBuilder = CoreHttpClientConfigurationBuilder.StatusCodesToRetry(statusCodesToRetry);
                return this;
            }

            /// <summary>
            /// Sets the RequestMethodsToRetry.
            /// </summary>
            /// <param name="requestMethodsToRetry"> RequestMethodsToRetry. </param>
            /// <returns>Builder.</returns>
            public Builder RequestMethodsToRetry(IList<HttpMethod> requestMethodsToRetry)
            {
                CoreHttpClientConfigurationBuilder = CoreHttpClientConfigurationBuilder.RequestMethodsToRetry(requestMethodsToRetry);
                return this;
            }

            /// <summary>
            /// Sets the HttpClientInstance.
            /// </summary>
            /// <param name="httpClientInstance"> HttpClientInstance. </param>
            /// <param name="overrideHttpClientConfiguration"> OverrideHttpClientConfiguration. </param>
            /// <returns>Builder.</returns>
            public Builder HttpClientInstance(HttpClient httpClientInstance, bool overrideHttpClientConfiguration = true)
            {
                CoreHttpClientConfigurationBuilder = CoreHttpClientConfigurationBuilder.HttpClientInstance(httpClientInstance, overrideHttpClientConfiguration);
                return this;
            }

            internal Builder RequestMethodsToRetry(IList<string> requestMethodsToRetry)
            {
                CoreHttpClientConfigurationBuilder =
                    CoreHttpClientConfigurationBuilder.RequestMethodsToRetry(requestMethodsToRetry.ToHttpMethods());
                return this;
            }            /// <summary>
            /// Sets the Proxy.
            /// </summary>
            /// <param name="proxyConfigurationBuilder"> ProxyConfigurationBuilder. </param>
            /// <returns>Builder.</returns>
            public Builder Proxy(ProxyConfigurationBuilder proxyConfigurationBuilder)
            {
                var proxyConfiguration = proxyConfigurationBuilder?.Build();
                CoreHttpClientConfigurationBuilder.ProxyConfiguration(proxyConfiguration);
                return this;
            }

            /// <summary>
            /// Creates an object of the HttpClientConfiguration using the values provided for the builder.
            /// </summary>
            /// <returns>HttpClientConfiguration.</returns>
            public HttpClientConfiguration Build()
            {
                return new HttpClientConfiguration(CoreHttpClientConfigurationBuilder);
            }
        }

        internal static Builder FromOptions(HttpClientConfigurationOptions options)
        {
            var builder = new Builder();
            if (options.Timeout != null)
                builder.Timeout(options.Timeout.Value);
            if (options.NumberOfRetries != null)
                builder.NumberOfRetries(options.NumberOfRetries.Value);
            if (options.BackoffFactor != null)
                builder.BackoffFactor(options.BackoffFactor.Value);
            if (options.RetryInterval != null)
                builder.RetryInterval(options.RetryInterval.Value);
            if (options.MaximumRetryWaitTime != null)
                builder.MaximumRetryWaitTime(options.MaximumRetryWaitTime.Value);
            if (options.StatusCodesToRetry != null)
                builder.StatusCodesToRetry(options.StatusCodesToRetry);
            if (options.RequestMethodsToRetry != null)
                builder.RequestMethodsToRetry(options.RequestMethodsToRetry);
            if (options.Proxy != null)
                builder.Proxy(ProxyConfigurationBuilder.FromOptions(options.Proxy));
            return builder;
        }
    }

    public class HttpClientConfigurationOptions
    {
        public TimeSpan? Timeout { get; set; }
        public int? NumberOfRetries { get; set; }
        public int? BackoffFactor { get; set; }
        public double? RetryInterval { get; set; }
        public TimeSpan? MaximumRetryWaitTime { get; set; }
        public IList<int> StatusCodesToRetry { get; set; }
        public IList<string> RequestMethodsToRetry { get; set; }
        public ProxyOptions Proxy { get; set; }
    }
    
    internal static class HttpClientConfigurationExtensions
    {
        public static IList<HttpMethod> ToHttpMethods(this IList<string> methodStrings)
        {
            return methodStrings == null
                ? new List<HttpMethod>()
                : methodStrings
                    .Select(m =>
                    {
                        var method = m.ToUpperInvariant();
                        switch (method)
                        {
                            case "GET": return HttpMethod.Get;
                            case "POST": return HttpMethod.Post;
                            case "PUT": return HttpMethod.Put;
                            case "DELETE": return HttpMethod.Delete;
                            case "HEAD": return HttpMethod.Head;
                            case "OPTIONS": return HttpMethod.Options;
                            case "TRACE": return HttpMethod.Trace;
                            case "PATCH": return new HttpMethod("PATCH");
                            default: return null; // Return null for unknown methods
                        }
                    })
                    .Where(m => m != null) // Filter out nulls
                    .ToList();
        }
    }
}
